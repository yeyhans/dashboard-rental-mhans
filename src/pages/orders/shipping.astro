---
import Base from '../../layout/Base.astro';
import { getServerAdmin, clearAuthCookies } from '../../lib/supabase';
import { ShippingService } from '../../services/shippingService';
import ShippingDashboard from '../../components/shipping/ShippingDashboard';
import { Toaster } from '../../components/ui/sonner';

// Verificar autenticaci√≥n usando el nuevo sistema
const adminSession = await getServerAdmin(Astro);

if (!adminSession) {
  console.log('üö´ Acceso denegado a shipping - Usuario no es administrador');
  clearAuthCookies(Astro);
  return Astro.redirect('/');
}

console.log('‚úÖ Admin autenticado en shipping:', adminSession.admin.email);

// Cargar datos iniciales de m√©todos de env√≠o
let initialShippingMethods = [];
let initialStats = null;
let error = null;

try {
  // Obtener los primeros 20 m√©todos de env√≠o
  const shippingResult = await ShippingService.getAllShippingMethods(1, 20);
  
  // Obtener estad√≠sticas de env√≠os
  const statsResult = await ShippingService.getShippingStats();
  
  initialShippingMethods = shippingResult.shippingMethods || [];
  initialStats = statsResult;
} catch (err) {
  console.error('Error loading initial shipping data:', err);
  error = 'Error al cargar los m√©todos de env√≠o iniciales';
  initialShippingMethods = [];
  initialStats = {
    totalMethods: 0,
    activeMethods: 0,
    totalShipments: 0,
    pendingShipments: 0,
    deliveredShipments: 0,
    totalRevenue: '0.00',
    deliveryRate: '0'
  };
}
---

<Base title="Gesti√≥n de Env√≠os - Sistema de Alquiler">
  <div class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8">
      {error && (
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
          <p><strong>Error:</strong> {error}</p>
        </div>
      )}
      
      <ShippingDashboard 
        client:load
        initialShippingMethods={initialShippingMethods}
        initialStats={initialStats}
      />
      
      <Toaster 
        client:load
        position="top-right"
        richColors={true}
        closeButton={true}
      />
    </div>
  </div>

  <!-- Estilos adicionales para el dashboard -->
  <style>
    /* Asegurar que el contenedor principal tenga el espacio correcto */
    .container {
      max-width: 1400px;
    }
    
    /* Estilos para mejorar la experiencia m√≥vil */
    @media (max-width: 768px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }
    
    /* Estilos para los di√°logos */
    [data-radix-portal] {
      z-index: 50;
    }
    
    /* Asegurar que los toasts aparezcan correctamente */
    [data-sonner-toaster] {
      z-index: 100;
    }
  </style>
</Base>