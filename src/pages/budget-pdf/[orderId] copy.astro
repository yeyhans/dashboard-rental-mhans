---
import { getServerUser, getServerUserProfile } from '../../lib/supabase';

let { orderId } = Astro.params;

if (!orderId) {
  return new Response('Order ID is required', { status: 400 });
}

// Remove .pdf extension if present
if (orderId.endsWith('.pdf')) {
  orderId = orderId.replace('.pdf', '');
}

// Check if it's an internal API request
const isInternalRequest = Astro.request.headers.get('X-Internal-Request') === 'true';
const requestedOrderIdFromHeader = Astro.request.headers.get('X-Requested-Order-Id');

if (isInternalRequest) {
  // Validate internal request
  if (requestedOrderIdFromHeader !== orderId) {
    console.error(`Internal request orderId mismatch: header=${requestedOrderIdFromHeader}, param=${orderId}`);
    return new Response('Internal request validation failed', { status: 400 });
  }
  console.log('‚úÖ Internal request validated for orderId:', orderId);
} else {
  // For direct requests, verify authentication using server-side method
  const user = await getServerUser(Astro);
  
  if (!user) {
    console.log('No authenticated user found');
    return Astro.redirect('/login');
  }

  // Get current user profile for authorization
  console.log('üîç Getting current user profile for authorization...');
  console.log('üîç Current user from getServerUser:', { id: user.id, email: user.email });
  console.log('üîç Requested orderId:', orderId);
  
  const currentUserProfile = await getServerUserProfile(Astro);
  console.log('üîç Current user profile result:', {
    hasProfile: !!currentUserProfile,
    hasProfileData: !!currentUserProfile?.profile,
    profileUserId: currentUserProfile?.profile?.user_id,
    profileAuthUid: currentUserProfile?.profile?.auth_uid
  });
  
  if (!currentUserProfile || !currentUserProfile.profile) {
    console.error('‚ùå No user profile found for current user');
    return new Response('User profile not found', { status: 404 });
  }
}

// Get order data
let orderData;
try {
  if (isInternalRequest) {
    // For internal requests, use service role key to get order data directly
    console.log('üîß Internal request: fetching order data with service role key');
    const { createClient } = await import('@supabase/supabase-js');
    const serviceSupabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL!,
      import.meta.env.SUPABASE_SERVICE_ROLE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY!
    );
    
    const { data: order, error } = await serviceSupabase
      .from('orders')
      .select('*')
      .eq('id', parseInt(orderId))
      .single();
    
    if (error || !order) {
      console.error('Error fetching order data for internal request:', error);
      return new Response('Order not found', { status: 404 });
    }
    
    orderData = order;
    console.log('‚úÖ Internal request: order data fetched successfully');
  } else {
    // For regular requests, use the server method with authorization check
    const { createClient } = await import('@supabase/supabase-js');
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL!,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY!
    );
    
    const { data: order, error } = await supabase
      .from('orders')
      .select('*')
      .eq('id', parseInt(orderId))
      .single();
      
    if (error || !order) {
      console.error('Error fetching order data:', error);
      return new Response('Order not found', { status: 404 });
    }
    
    // Verify user can only access their own orders
    const currentUserProfile = await getServerUserProfile(Astro);
    if (!currentUserProfile?.profile) {
      return new Response('User profile not found', { status: 404 });
    }
    
    // Check if the order belongs to the current user
    const userMatches = order.customer_id === currentUserProfile.profile.user_id?.toString() ||
                       order.customer_id === currentUserProfile.profile.auth_uid ||
                       order.customer_id === currentUserProfile.auth?.id;
    
    if (!userMatches) {
      console.warn(`‚ùå Unauthorized access attempt to order ${orderId} by user ${currentUserProfile.profile.user_id}`);
      return Astro.redirect('/404');
    }
    
    orderData = order;
  }
} catch (error) {
  console.error('Error fetching order data:', error);
  return new Response('Error fetching order data', { status: 500 });
}

// Set security headers
Astro.response.headers.set('X-Frame-Options', 'DENY');
Astro.response.headers.set('X-Content-Type-Options', 'nosniff');
Astro.response.headers.set('Cache-Control', 'private, no-cache, no-store, must-revalidate');

// Generate current date
const currentDate = new Date().toLocaleDateString('es-CL', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Function to format date to DD-MM-AAAA
const formatDateToDDMMAAAA = (dateString: string) => {
  if (!dateString) return '';
  
  try {
    // Try to parse the date string
    const date = new Date(dateString);
    
    // Check if the date is valid
    if (isNaN(date.getTime())) {
      // If it's not a valid date, check if it's already in DD-MM-AAAA format
      if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
        return dateString;
      }
      return dateString; // Return as-is if we can't parse it
    }
    
    // Format to DD-MM-AAAA
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    
    return `${day}-${month}-${year}`;
  } catch (error) {
    console.error('Error formatting date:', error);
    return dateString; // Return original string if there's an error
  }
};

// Parse order data with fallbacks for all column formats
const billing = orderData.billing || {};
const metadata = orderData.metadata || {};
const lineItems = orderData.line_items || [];
const couponLines = orderData.coupon_lines || [];
const shippingLines = orderData.shipping_lines || [];

// Extract data with fallbacks (supports both nested and flat structures)
const customerFirstName = billing.first_name || orderData.billing_first_name || '';
const customerLastName = billing.last_name || orderData.billing_last_name || '';
const customerCompany = billing.company || orderData.billing_company || '';
const customerEmail = billing.email || orderData.billing_email || '';
const customerPhone = billing.phone || orderData.billing_phone || '';
const customerAddress = billing.address_1 || orderData.billing_address_1 || '';
const customerCity = billing.city || orderData.billing_city || '';
const customerRut = billing.rut || orderData.billing_rut || '';

// Project information with fallbacks
const projectName = metadata.order_proyecto || orderData.order_proyecto || 'Proyecto de Arriendo';
const startDate = formatDateToDDMMAAAA(metadata.order_fecha_inicio || orderData.order_fecha_inicio || '');
const endDate = formatDateToDDMMAAAA(metadata.order_fecha_termino || orderData.order_fecha_termino || '');
const numJornadas = parseInt(metadata.num_jornadas || orderData.num_jornadas || '1');
const companyRut = metadata.company_rut || orderData.company_rut || '';

// Additional order information (for future use)
const retireName = metadata.order_retire_name || orderData.order_retire_name || '';
const retirePhone = metadata.order_retire_phone || orderData.order_retire_phone || '';
const retireRut = metadata.order_retire_rut || orderData.order_retire_rut || '';
const comments = metadata.order_comments || orderData.order_comments || '';

// Calculate totals with fallbacks (original values from order)
const originalSubtotal = parseFloat(metadata.calculated_subtotal || orderData.calculated_subtotal || '0');
const discount = parseFloat(metadata.calculated_discount || orderData.calculated_discount || '0');
const originalIva = parseFloat(metadata.calculated_iva || orderData.calculated_iva || '0');
const originalTotal = parseFloat(metadata.calculated_total || orderData.calculated_total || '0');

// Calculate products-only totals (excluding shipping and discounts)
const productsSubtotal = lineItems.reduce((sum, item) => {
  return sum + (item.price * item.quantity * numJornadas);
}, 0);
const productsIva = productsSubtotal * 0.19;
const productsTotal = productsSubtotal * 1.19;

// Use products-only totals for the subtotal row
const subtotal = productsSubtotal;
const iva = productsIva;
const total = productsTotal;
const reserve = originalTotal * 0.25;

// Function to translate order status to Spanish
const getOrderStatusInSpanish = (status: string) => {
  const statusMap: { [key: string]: string } = {
    'pending': 'Pendiente',
    'processing': 'En Proceso',
    'on-hold': 'En Espera',
    'completed': 'Completado',
    'cancelled': 'Cancelado',
    'refunded': 'Reembolsado',
    'failed': 'Fallido',
    'draft': 'Borrador',
    'trash': 'Eliminado',
  };
  
  return statusMap[status] || status.charAt(0).toUpperCase() + status.slice(1);
};

// Additional order information
const orderIdNum = orderData.id || orderData.order_id;
const orderStatus = getOrderStatusInSpanish(orderData.status || 'on-hold');
const paymentMethod = orderData.payment_method || orderData.payment_method_title || 'Por definir';

// Process shipping information
let shippingInfo = null;
if (shippingLines && shippingLines.length > 0) {
  const shippingLine = shippingLines[0]; // Get first shipping method
  const shippingMetadata = shippingLine.meta_data || {};
  
  shippingInfo = {
    method_title: shippingLine.method_title || 'M√©todo de env√≠o',
    method_type: shippingLine.method_type || '',
    total: parseFloat(shippingLine.total || '0'),
    delivery_method: shippingMetadata.delivery_method || '',
    estimated_delivery: shippingMetadata.estimated_delivery || '',
    tracking_number: shippingMetadata.tracking_number || null
  };
}

// Format currency
const formatCLP = (amount: number) => {
  return new Intl.NumberFormat('es-CL', { 
    style: 'currency', 
    currency: 'CLP',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount);
};

// Generate budget number
const budgetNumber = `PRES-${orderIdNum}-${Date.now().toString().slice(-6)}`;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presupuesto de Arriendo - {customerFirstName} {customerLastName}</title>
  <style>
    @page {
      size: A4;
      margin: 20mm;
    }
    
    body {
      font-family: Arial, sans-serif;
      font-size: 10px;
      line-height: 1.3;
      margin: 0;
      padding: 0;
      color: #000;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      border-bottom: 2px solid #000;
      padding-bottom: 15px;
    }
    
    .logo {
      width: 150px;
    }
    
    .document-title {
      text-align: center;
      flex-grow: 1;
    }
    
    .document-title h1 {
      font-size: 14px;
      font-weight: bold;
      margin: 0;
      text-transform: uppercase;
      color: #000;
    }
    
    .order-info {
      text-align: right;
      min-width: 150px;
    }
    
    .order-info h2 {
      font-size: 12px;
      margin: 0 0 5px 0;
      font-weight: bold;
      color: #000;
    }
    
    .order-info p {
      margin: 2px 0;
      font-size: 9px;
      color: #000;
    }
    
    .customer-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
    }
    
    .customer-details, .project-details {
      width: 48%;
    }
    
    .customer-details h3, .project-details h3 {
      font-size: 11px;
      font-weight: bold;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      border-bottom: 1px solid #000;
      padding-bottom: 3px;
      color: #000;
    }
    
    .customer-details p, .project-details p {
      margin: 2px 0;
      font-size: 9px;
      color: #000;
    }
    
    .retiro-details {
      width: 48%;
    }
    
    .retiro-details h3, .project-details h3 {
      font-size: 11px;
      font-weight: bold;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      border-bottom: 1px solid #000;
      padding-bottom: 3px;
      color: #000;
    }
    
    .retiro-details p {
      margin: 2px 0;
      font-size: 9px;
      color: #000;
    }
    
    .shipping-info {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f9f9f9;
      border: 1px solid #000;
      border-radius: 0;
    }
    
    .shipping-info h3 {
      font-size: 11px;
      font-weight: bold;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      border-bottom: 1px solid #000;
      padding-bottom: 3px;
      color: #000;
    }
    
    .shipping-details p {
      margin: 3px 0;
      font-size: 9px;
      color: #000;
    }
    
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 2px solid #000;
    }
    
    .items-table th {
      background-color: #f0f0f0;
      padding: 6px;
      text-align: left;
      font-size: 9px;
      font-weight: bold;
      text-transform: uppercase;
      color: #000;
      border-bottom: 2px solid #000;
      border-right: 1px solid #000;
    }
    
    .items-table th:last-child {
      border-right: none;
    }
    
    .items-table td {
      padding: 4px 6px;
      font-size: 9px;
      color: #000;
      border-bottom: 1px solid #000;
      border-right: 1px solid #000;
    }
    
    .items-table td:last-child {
      border-right: none;
    }
    
    .items-table .text-right {
      text-align: right;
    }
    
    .items-table .text-center {
      text-align: center;
    }
    
    /* Subtotal row styles */
    .subtotal-row {
      border-top: 2px solid #000;
      border-bottom: 1px solid #000;
    }
    
    .subtotal-row .subtotal-label {
      font-weight: bold;
      font-size: 9px;
      padding: 6px;
      background-color: #f0f0f0;
    }
    
    .subtotal-row .subtotal-value {
      font-weight: bold;
      font-size: 9px;
      padding: 6px;
      background-color: #f0f0f0;
    }
    
    /* Final totals section */
    .final-totals-section {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 30px;
      margin-top: 20px;
    }
    
    .final-totals-table {
      width: 250px;
      border-collapse: collapse;
      border: 2px solid #000;
    }
    
    .final-totals-table td {
      padding: 8px 12px;
      font-size: 10px;
      color: #000;
      border-bottom: 1px solid #000;
    }
    
    .final-totals-table .final-label {
      text-align: left;
      font-weight: bold;
      width: 60%;
      color: #000;
      background-color: #f0f0f0;
    }
    
    .final-totals-table .final-amount {
      text-align: right;
      width: 40%;
      color: #000;
      font-weight: bold;
    }
    
    .final-totals-table .final-total-row {
      border-bottom: none;
      font-size: 11px;
    }
    
    .final-totals-table .final-total-row .final-label {
      background-color: #e0e0e0;
      font-size: 11px;
    }
    
    .final-totals-table .final-total-row .final-amount {
      font-size: 11px;
    }
    
    .reserve-section {
      background-color: #f9f9f9;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #000;
    }
    
    .reserve-section h3 {
      margin: 0 0 8px 0;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      color: #000;
    }
    
    .reserve-section p {
      margin: 2px 0;
      font-size: 9px;
      color: #000;
    }
    
    .shipping-summary {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #000;
    }
    
    .shipping-summary p {
      margin: 2px 0;
      font-size: 9px;
      color: #000;
    }
    
    .terms-section {
      margin-top: 20px;
      font-size: 8px;
      line-height: 1.2;
      color: #000;
    }
    
    .terms-section h3 {
      font-size: 10px;
      font-weight: bold;
      margin: 10px 0 6px 0;
      text-transform: uppercase;
      color: #000;
    }
    
    .terms-section p, .terms-section ul {
      margin: 3px 0;
      color: #000;
    }
    
    .terms-section ul {
      padding-left: 15px;
    }
    
    .footer-info {
      margin-top: 30px;
      padding-top: 10px;
      border-top: 1px solid #000;
      font-size: 8px;
      text-align: center;
      color: #000;
    }
    
    .company-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      color: #000;
      border-top: 2px solid #000;
      background-color: #f9f9f9;
    }
    
    .company-footer .logo-section {
      display: flex;
      align-items: center;
      flex: 1;
    }
    
    .company-footer .logo-footer {
      width: 100px;
      height: 100px;
      background-color: white;
    }
    
    .company-footer .company-name {
      color: #000;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .company-footer .contact-info {
      text-align: right;
      font-size: 8px;
      line-height: 1.3;
    }
    
    .company-footer .contact-info p {
      margin: 1px 0;
      color: #000;
    }
    
    .company-footer .contact-info .highlight {
      color: #000;
      font-weight: bold;
    }
    
    .company-footer .disclaimer {
      flex: 2;
      text-align: center;
      font-size: 8px;
      line-height: 1.2;
      padding: 0 15px;
      color: #000;
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="header">
    <div class="logo">
      <img src="https://media.mariohans.cl/logos/Recurso%2016%403x.png" alt="Rental Mhans" class="logo">
    </div>
    <div class="document-title">
      
    </div>
    <div class="order-info">
      <h2>Pedido #{orderIdNum}</h2>
      <p><strong>Fecha:</strong> {currentDate}</p>
      <p><strong>Estado:</strong> {orderStatus}</p>
    </div>
  </div>

  <!-- Customer and Project Information -->
  <div class="customer-info">
    <div class="customer-details">
      <p><strong>Nombre:</strong> {customerFirstName} {customerLastName}</p>
      {customerCompany && <p><strong>Empresa:</strong> {customerCompany}</p>}
      <p><strong>RUT:</strong> {companyRut}</p>
      <p><strong>Email:</strong> {customerEmail}</p>
      <p><strong>Tel√©fono:</strong> {customerPhone}</p>
      <p><strong>Direcci√≥n:</strong> {customerAddress}</p>
      <p><strong>Ciudad:</strong> {customerCity}</p>
    </div>
    
    <div class="project-details">
      <p><strong>Proyecto:</strong> {projectName}</p>
      <p><strong>Fecha Inicio:</strong> {startDate}</p>
      <p><strong>Fecha T√©rmino:</strong> {endDate}</p>
      <p><strong>N√∫mero de Jornadas:</strong> {numJornadas}</p>

    </div>
    <div class="retiro-details">
      <p><strong>Retira:</strong> {retireName}</p>
      <p><strong>Tel√©fono Retiro:</strong> {retirePhone}</p>
      <p><strong>RUT Retiro:</strong> {retireRut}</p>
      <p><strong>Comentarios:</strong> {comments}</p>
    </div>
  </div>

  <!-- Items Table -->
  <table class="items-table">
    <thead>
      <tr>
        <th style="width: 40%">ITEM</th>
        <th style="width: 10%" class="text-right">Valor Diario</th>
        <th style="width: 10%" class="text-right">Cantidad</th>
        <th style="width: 10%" class="text-right">Jornadas</th>
        <th style="width: 10%" class="text-right">NETO</th>
        <th style="width: 10%" class="text-right">IVA 19%</th>
        <th style="width: 10%" class="text-right">TOTAL BRUTO</th>
      </tr>
    </thead>
    <tbody>
      <!-- Line Items will be inserted here dynamically -->
      {lineItems.map(item => (
        <tr>
          <td>{item.name}</td>
          <td class="text-right">{formatCLP(item.price)}</td>
          <td class="text-right">{item.quantity}</td>
          <td class="text-right">{numJornadas}</td>
          <td class="text-right">{formatCLP(item.price * item.quantity * numJornadas)}</td>
          <td class="text-right">{formatCLP((item.price * item.quantity * numJornadas) * 0.19)}</td>
          <td class="text-right">{formatCLP((item.price * item.quantity * numJornadas) * 1.19)}</td>
        </tr>
      ))}
      
      <!-- Subtotal row with border -->
      <tr class="subtotal-row">
        <td colspan="4" class="subtotal-label"><strong>SUB TOTAL</strong></td>
        <td class="text-right subtotal-value">{formatCLP(subtotal)}</td>
        <td class="text-right subtotal-value">{formatCLP(iva)}</td>
        <td class="text-right subtotal-value">{formatCLP(total)}</td>
      </tr>
      
      <!-- Coupon Lines (if any) -->
      {couponLines.length > 0 && couponLines.map(coupon => (
        <tr>
          <td colspan="4"><strong>DESCUENTO -{coupon.code}</strong></td>
          <td class="text-right">-{formatCLP(coupon.discount)}</td>
          <td class="text-right">-{formatCLP(coupon.discount * 0.19)}</td>
          <td class="text-right">-{formatCLP(coupon.discount * 1.19)}</td>
        </tr>
      ))}
      
      <!-- Shipping Line (if any) -->
      {shippingInfo && (
        <tr>
          <td colspan="4">
            <strong>Env√≠o SM</strong>
          </td>
          <td class="text-right">{shippingInfo.total > 0 ? formatCLP(shippingInfo.total) : '$0'}</td>
          <td class="text-right">{shippingInfo.total > 0 ? formatCLP(shippingInfo.total * 0.19) : '$0'}</td>
          <td class="text-right">{shippingInfo.total > 0 ? formatCLP(shippingInfo.total * 1.19) : '$0'}</td>
        </tr>
      )}
    </tbody>
  </table>

  <!-- Final Totals Section -->
  <div class="final-totals-section">
    <table class="final-totals-table">
      <tr class="final-subtotal-row">
        <td class="final-label">SUB TOTAL</td>
        <td class="final-amount">{formatCLP(originalSubtotal)}</td>
      </tr>
      <tr class="final-iva-row">
        <td class="final-label">IVA</td>
        <td class="final-amount">{formatCLP(originalIva)}</td>
      </tr>
      <tr class="final-total-row">
        <td class="final-label">TOTAL</td>
        <td class="final-amount">{formatCLP(originalTotal)}</td>
      </tr>
    </table>
  </div>

  <!-- Reserve Section -->
  <div class="reserve-section">
    <h3>Reserva (25%)</h3>
    <p><strong>Monto de Reserva:</strong> {formatCLP(reserve)}</p>
    <p>Para confirmar la reserva de los equipos, se requiere el pago del 25% del valor total del arriendo.</p>
    <p><strong>M√©todo de Pago:</strong> {paymentMethod}</p>
    <p><strong>Saldo Pendiente:</strong> {formatCLP(total - reserve)}</p>
    {shippingInfo && (
      <div class="shipping-summary">
        <p><strong>Informaci√≥n de Entrega:</strong> {shippingInfo.method_title}</p>
        {shippingInfo.estimated_delivery && (
          <p><strong>Tiempo Estimado:</strong> {shippingInfo.estimated_delivery}</p>
        )}
      </div>
    )}
  </div>

  <!-- Footer -->
  <div class="company-footer">
    <div class="logo-section">
      <img src="https://media.mariohans.cl/logos/Recurso%2010%402x.png" alt="Rental Mhans" class="logo-footer">
    </div>
    
    <div class="disclaimer">
      <p>Estamos revisando la disponibilidad de los equipos</p>
      <p>que seleccionaste, muy pronto confirmaremos</p>
      <p>su disponibilidad.</p>
    </div>
    
    <div class="contact-info">
      <p class="highlight">MHANS FILMS SPA</p>
      <p>76.650.506-8</p>
      <p>Fono 56-Chile</p>
      <p>FAN Empresarial, Cuenta vista</p>
      <p>390024552</p>
      <p>pagos@mrentalhans.cl</p>
    </div>
  </div>

  <div class="footer-info">
    <p>Este presupuesto fue generado autom√°ticamente el {currentDate}</p>
  </div>
</body>
</html>
