---
import Base from "../layout/Base.astro";
import UsersDashboardWithToaster from "../components/UsersDashboardWithToaster";
import { supabase } from "../lib/supabase";
import { UserService } from "../services/userService";

export const prerender = false;

if (!supabase) {
  throw new Error("Supabase client is not initialized.");
}
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

// Load ALL users for client-side pagination and filtering
// This ensures we have all data available for proper pagination
const { users, total } = await UserService.searchUsers('', 1, 1000); // Load up to 1000 users

const usersData = {
  users: users || [],
  total: total || 0,
  sessionToken: session.access_token // Pass the access token to client
};

const title = "Gesti√≥n de Usuarios";
---

<Base title={title}>
  <div class="container py-6">
    <UsersDashboardWithToaster 
      client:load
      initialUsers={usersData.users}
      initialTotal={usersData.total}
      sessionToken={usersData.sessionToken}
    />
  </div>
</Base>
