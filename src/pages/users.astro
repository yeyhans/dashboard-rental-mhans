---
import Base from "../layout/Base.astro";
import UsersDashboardWithToaster from "../components/UsersDashboardWithToaster";
import { getServerAdmin, clearAuthCookies } from "../lib/supabase";
import { UserService } from "../services/userService";

export const prerender = false;

// Verificar autenticaci√≥n usando el nuevo sistema
const adminSession = await getServerAdmin(Astro);

if (!adminSession) {
  console.log('üö´ Acceso denegado a users - Usuario no es administrador');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

console.log('‚úÖ Admin autenticado en users:', adminSession.admin.email);

// Obtener el token de sesi√≥n de las cookies para pasarlo al componente
const sessionToken = Astro.cookies.get('sb-access-token')?.value || '';

if (!sessionToken) {
  console.warn('‚ö†Ô∏è No se encontr√≥ token de sesi√≥n en cookies');
}

// Cargar usuarios para paginaci√≥n y filtrado del lado del cliente
const { users, total } = await UserService.searchUsers('', 1, 1000); // Cargar hasta 1000 usuarios

const usersData = {
  users: users || [],
  total: total || 0,
  adminInfo: {
    email: adminSession.admin.email,
    role: adminSession.admin.role,
    sessionExpiry: adminSession.expiresAt.toISOString()
  }
};

const title = `Gesti√≥n de Usuarios | ${adminSession.admin.email}`;
---

<Base title={title}>
  <div class="container py-6">
    <UsersDashboardWithToaster 
      client:load
      initialUsers={usersData.users}
      initialTotal={usersData.total}
      sessionToken={sessionToken}
    />
  </div>
</Base>
