---
import Base from "../layout/Base.astro";
import UsersDashboard from "../components/UsersDashboard";
import { supabase } from "../lib/supabase";
import { UserService } from "../services/userService";

export const prerender = false;

if (!supabase) {
  throw new Error("Supabase client is not initialized.");
}
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

// Fetch users data using the professional service
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1', 10);
const limit = parseInt(url.searchParams.get('limit') || '10', 10);
const search = url.searchParams.get('search') || '';

const { users, total, totalPages } = await UserService.searchUsers(search, page, limit);

const usersData = {
  users: users || [],
  total: total || 0,
  totalPages: totalPages || 0
};

const title = "Gesti√≥n de Usuarios";
---

<Base title={title}>
  <div class="container py-6">
    <UsersDashboard 
      client:load
      initialUsers={usersData.users}
      initialTotal={usersData.total}
      initialTotalPages={usersData.totalPages}
    />
  </div>
</Base>
