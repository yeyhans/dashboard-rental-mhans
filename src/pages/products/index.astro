---
import Base from "../../layout/Base.astro";
import ProductsDashboard from "../../components/ProductsDashboard";
import { supabase } from "../../lib/supabase";
import { ProductService } from "../../services/productService";
import { CategoryService } from "../../services/categoryService";

export const prerender = false;

if (!supabase) {
  throw new Error("Supabase client is not initialized.");
}
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

// Get URL parameters for initial load
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1', 10);
const limit = parseInt(url.searchParams.get('limit') || '50', 10);
const search = url.searchParams.get('search') || '';
const categoryIdString = url.searchParams.get('categoryId');
const categoryId = categoryIdString ? parseInt(categoryIdString, 10) : undefined;

// Fetch products and categories data using the professional services
const { products, total } = await ProductService.searchProducts(search, page, limit, categoryId);
const { categories } = await CategoryService.getAllCategories(1, 100); // Fetch all categories

const productsData = {
  data: {
    products: products || [],
    total: total || 0
  }
};

const categoriesData = {
  data: {
    categories: categories || []
  }
};

const title = "Gesti√≥n de Productos";
---

<Base title={title}>
  <div class="container py-6">
    <ProductsDashboard 
      client:load
      initialProducts={productsData.data.products as any}
      initialTotal={productsData.data.total}
      initialCategories={categoriesData.data.categories as any}
    />
  </div>
</Base>
