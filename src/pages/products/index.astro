---
import Base from "../../layout/Base.astro";
import ProductsDashboard from "../../components/ProductsDashboard";
import { getServerAdmin, clearAuthCookies } from "../../lib/supabase";
import { ProductService } from "../../services/productService";
import { CategoryService } from "../../services/categoryService";

export const prerender = false;

// Verificar autenticaci√≥n usando el nuevo sistema
const adminSession = await getServerAdmin(Astro);

if (!adminSession) {
  console.log('üö´ Acceso denegado a products - Usuario no es administrador');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

console.log('‚úÖ Admin autenticado en products:', adminSession.admin.email);

// Extract access token from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value || '';

if (!accessToken) {
  console.error('‚ùå No access token found in cookies');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

// Load ALL products and categories for client-side pagination and filtering
// This ensures we have all data available for proper pagination
const { products, total } = await ProductService.searchProducts('', 1, 1000); // Load up to 1000 products
const { categories } = await CategoryService.getAllCategories(1, 100); // Load all categories

const productsData = {
  products: products || [],
  total: total || 0
};

const categoriesData = {
  categories: categories || []
};

const title = `Gesti√≥n de Productos | ${adminSession.admin.email}`;
---

<Base title={title}>
  <div class="container py-6">
    <ProductsDashboard 
      client:load
      initialProducts={productsData.products as any}
      initialTotal={productsData.total}
      initialCategories={categoriesData.categories as any}
      accessToken={accessToken}
    />
  </div>
</Base>
