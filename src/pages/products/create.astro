---
import Base from "../../layout/Base.astro";
import { getServerAdmin, clearAuthCookies } from "../../lib/supabase";
import ProductForm from "../../components/products/ProductForm";
import { CategoryService } from "../../services/categoryService";

export const prerender = false;

// Verificar autenticaci√≥n usando el nuevo sistema
const adminSession = await getServerAdmin(Astro);

if (!adminSession) {
  console.log('üö´ Acceso denegado a create product - Usuario no es administrador');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

console.log('‚úÖ Admin autenticado en create product:', adminSession.admin.email);

// Extract access token from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value || '';

if (!accessToken) {
  console.error('‚ùå No access token found in cookies');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

// Fetch categories for the form
const { categories } = await CategoryService.getAllCategories(1, 100); // Fetch all categories

const categoriesData = {
  categories: categories || []
};

const title = `Crear Nuevo Producto | ${adminSession.admin.email}`;
---

<Base title={title}>
  <div class="container py-6 max-w-6xl mx-auto">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-foreground mb-2">Crear Nuevo Producto</h1>
      <p class="text-sm text-muted-foreground">
        Completa la informaci√≥n del producto. Los campos marcados con * son obligatorios.
      </p>
    </div>
    <ProductForm
      client:load
      categories={categoriesData.categories as any}
      redirectOnSuccess="/products"
      onCancel={() => {
        if (typeof window !== 'undefined') {
          window.location.href = '/products';
        }
      }}
    />
  </div>
</Base>

