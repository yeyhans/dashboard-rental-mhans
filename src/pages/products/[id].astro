---
import Base from "../../layout/Base.astro";
import { getServerAdmin, clearAuthCookies } from "../../lib/supabase";
import { ProductDetailController } from "../../components/products/ProductDetailController";
import { ProductService } from "../../services/productService";
import { CategoryService } from "../../services/categoryService";

export const prerender = false;

// Verificar autenticaci√≥n usando el nuevo sistema
const adminSession = await getServerAdmin(Astro);

if (!adminSession) {
  console.log('üö´ Acceso denegado a product detail - Usuario no es administrador');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

console.log('‚úÖ Admin autenticado en product detail:', adminSession.admin.email);

// Extract access token from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value || '';

if (!accessToken) {
  console.error('‚ùå No access token found in cookies');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

// Get the product ID from the URL parameter
const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/products");
}

// Fetch the product and categories data using the professional services
const product = await ProductService.getProductById(parseInt(id, 10));
const { categories } = await CategoryService.getAllCategories(1, 100); // Fetch all categories

const productData = { success: !!product, data: product };
const title = productData.success ? `Producto: ${productData.data.name}` : "Producto no encontrado";
---

<Base title={title}>
  {productData.success ? (
    <ProductDetailController 
      client:load
      initialProduct={productData.data} 
      initialCategories={categories}
      accessToken={accessToken}
    />
  ) : (
    <div class="container py-4 px-4 max-w-6xl mx-auto">
      <div class="p-6 bg-destructive/10 text-destructive rounded-md">
        <p class="font-medium">Error al cargar el producto: {productData.message}</p>
        <p class="mt-2">Por favor, intenta nuevamente o contacta al administrador.</p>
      </div>
    </div>
  )}
</Base>
