---
import Base from "../../layout/Base.astro";
import PaymentsTable from "../../components/payments/PaymentsTable";
import { getServerAdmin, clearAuthCookies } from "../../lib/supabase";
import { OrderService } from "../../services/orderService";

export const prerender = false;

// Verificar autenticaciÃ³n usando el nuevo sistema
const adminSession = await getServerAdmin(Astro);

if (!adminSession) {
  console.log('ðŸš« Acceso denegado a payments - Usuario no es administrador');
  clearAuthCookies(Astro);
  return Astro.redirect("/");
}

console.log('âœ… Admin autenticado en payments:', adminSession.admin.email);

// Load only COMPLETED orders for payments table
// This ensures we only show orders that have been completed
const { orders, total } = await OrderService.getCompletedOrders(1, 1000); // Load up to 1000 completed orders

const ordersData = {
  orders: orders || [],
  total: total || 0
};

const title = `Tabla de Pagos | ${adminSession.admin.email}`;
---

<Base title={title}>
  <div class="container py-6">
    <PaymentsTable 
      client:load
      initialOrders={ordersData.orders}
      initialTotal={ordersData.total.toString()}
    />
  </div>
</Base> 