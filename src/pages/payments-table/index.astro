---
import Base from "../../layout/Base.astro";
import PaymentsTable from "../../components/payments/PaymentsTable";
import { supabase } from "../../lib/supabase";
import { OrderService } from "../../services/orderService";

export const prerender = false;

if (!supabase) {
  throw new Error("Supabase client is not initialized.");
}
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

// Get URL parameters for initial load
const url = new URL(Astro.request.url);
const status = url.searchParams.get('status') || undefined;
const page = parseInt(url.searchParams.get('page') || '1', 10);
const limit = parseInt(url.searchParams.get('limit') || '20', 10);

// Fetch orders data using the professional service
const { orders, total } = await OrderService.getAllOrders(page, limit, status);

const ordersData = {
  data: {
    orders: orders || [],
    total: total || 0
  }
};

const title = "Tabla de Pagos";
---

<Base title={title}>
  <div class="container py-6">
    <PaymentsTable 
      client:load
      initialOrders={ordersData.data.orders}
      initialTotal={ordersData.data.total.toString()}
      initialStatus={status}
    />
  </div>
</Base> 