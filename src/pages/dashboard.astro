--- 
import Base from "../layout/Base.astro";
import { supabase } from "../lib/supabase";
import { DashboardService } from "../services/dashboardService";
import DashboardContainer from "../components/DashboardContainer";

export const prerender = false;

// Get session from Supabase
if (!supabase) {
  console.error('Supabase client is not initialized. Check environment variables.');
  return Astro.redirect("/");
}

const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

// Verify the user is an admin from the 'admin_users' table
const { data: adminUser, error: adminError } = await supabase
  .from('admin_users')
  .select('*')
  .eq('user_id', session.user.id)
  .eq('role', 'admin')
  .single();

if (adminError || !adminUser) {
  console.error('Admin verification failed:', adminError?.message);
  // Clear cookies and redirect to login if not an admin
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect("/");
}

// Fetch comprehensive dashboard data using the service
let dashboardStats;
try {
  dashboardStats = await DashboardService.getDashboardStats();
  console.log('Dashboard Stats loaded successfully:', {
    monthlyOrders: dashboardStats.monthlyOrderStats.totalOrders,
    rentedEquipment: dashboardStats.rentedEquipment.length,
    totalSales: dashboardStats.financialSummary.totalSales
  });
} catch (error) {
  console.error('Error fetching dashboard stats:', error);
  // Initialize with empty data structure
  dashboardStats = {
    monthlyOrderStats: {
      totalOrders: 0,
      completedOrders: 0,
      createdOrders: 0,
      pendingOrders: 0,
      processingOrders: 0,
      onHoldOrders: 0
    },
    ordersByStatus: {
      onHold: [],
      pending: [],
      processing: [],
      completed: []
    },
    rentedEquipment: [],
    financialSummary: {
      totalSales: 0,
      totalPaid: 0,
      totalPending: 0,
      reservationPayments: 0,
      finalPayments: 0
    }
  };
}

const title = "Dashboard - Rental Mhans";
---

<Base title={title}>
  <div class="container py-3 px-2 sm:px-4">
    <!-- Dashboard Header -->
    <div class="mb-3">
      <h1 class="text-xl font-bold">Dashboard</h1>
      <p class="text-xs text-muted-foreground">Bienvenido al panel de control de Rental Mhans</p>
    </div>
    
    <!-- Dashboard Integrado con Filtros -->
    <DashboardContainer 
      client:load
      initialData={dashboardStats}
    />

  </div>
</Base>
