--- 
import Base from "../layout/Base.astro";
import { supabase } from "../lib/supabase";
import { DashboardService } from "../services/dashboardService";
import DashboardContainer from "../components/DashboardContainer";

export const prerender = false;

// Get session from Supabase
if (!supabase) {
  console.error('Supabase client is not initialized. Check environment variables.');
  return Astro.redirect("/");
}

const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/");
}

// Verify the user is an admin from the 'admin_users' table
const { data: adminUser, error: adminError } = await supabase
  .from('admin_users')
  .select('*')
  .eq('user_id', session.user.id)
  .eq('role', 'admin')
  .single();

if (adminError || !adminUser) {
  console.error('Admin verification failed:', adminError?.message);
  // Clear cookies and redirect to login if not an admin
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect("/");
}

// Fetch comprehensive dashboard data using the service
let dashboardStats;
try {
  dashboardStats = await DashboardService.getDashboardStats();
  console.log('Dashboard Stats loaded successfully:', {
    monthlyOrders: dashboardStats.monthlyOrderStats.totalOrders,
    rentedEquipment: dashboardStats.rentedEquipment.length,
    totalSales: dashboardStats.financialSummary.totalSales
  });
} catch (error) {
  console.error('Error fetching dashboard stats:', error);
  // Initialize with empty data structure
  dashboardStats = {
    monthlyOrderStats: {
      totalOrders: 0,
      completedOrders: 0,
      createdOrders: 0,
      pendingOrders: 0,
      processingOrders: 0,
      onHoldOrders: 0
    },
    ordersByStatus: {
      onHold: [],
      pending: [],
      processing: [],
      completed: []
    },
    rentedEquipment: [],
    financialSummary: {
      totalSales: 0,
      totalPaid: 0,
      totalPending: 0,
      reservationPayments: 0,
      finalPayments: 0
    }
  };
}

const title = "Dashboard - Rental Mario Hans";
---

<Base title={title}>
  <div class="container py-3 px-2 sm:px-4">
    <!-- Dashboard Header -->
    <div class="mb-3 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
      <div>
        <h1 class="text-xl font-bold">Dashboard</h1>
        <p class="text-xs text-muted-foreground">Bienvenido al panel de control de Rental Mario Hans</p>
      </div>
      <div class="flex gap-2">
        <a 
          href="/analytics" 
          class="inline-flex items-center gap-2 px-3 py-2 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Analytics Avanzados
        </a>
      </div>
    </div>
    
    <!-- Dashboard Integrado con Filtros -->
    <DashboardContainer 
      client:load
      initialData={dashboardStats}
    />

  </div>
</Base>
